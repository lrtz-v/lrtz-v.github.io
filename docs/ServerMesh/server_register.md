---
template: main.html
tags:
  - Service Mesh
  - 注册中心
---

# 服务注册中心

## 健康检查设计

- 服务主动探活
  - 服务定时发送租约信息给注册中心
  - 写操作压力大、主动租约不能保证服务健康
- 注册中心发起健康检查
  - 可能会发生旧服务重新激活的问题
  - 可用 envory 做服务名检查
- 调用房的负载均衡器进行健康检查
  - 如 grpc 的自动摘除节点
  - IP 重用产生脏数据

## 注册中心的选型

| 特征         | Nacos | Eureka | Zookeeper  | Consul | Etcd   |
| ------------ | ----- | ------ | ---------- | ------ | ------ |
| 一致性协议   | AP    | AP     | CP         | CP     | CP     |
| 健康检查     | 多种  | TTL    | Keep Alive | 多种   | TTL    |
| 网络异常保护 | 支持  | 支持   | 不支持     | 支持   | 不支持 |
| 实现语言     | Java  | Java   | Java       | Go     | Go     |

## 搭建高可用的注册中心

- Q1：注册中心故障了，服务是否还能正常访问？
  - 只要服务缓存了服务数据，影响面可控
  - 服务无法扩容
- Q2：注册中心因为高负载，推送了异常的数据，服务是否还能正常访问？
  - 在客户端的服务发现 SDk 中加入自我保护机制，当服务的节点数量下降超过一定阈值，就进入保护机制，放弃使用新推送过来的服务注册信息
- Q3：新加入的机器，出现了网络联通性问题（注册中心与服务网络正常，服务之间网络异常），应该怎样应对？
  - 在负载均衡中加入被动健康检查（节点熔断）和主动健康检查，主动剔除失效的节点
- Q4：服务是否应该完全信任注册中心推送的数据？

  - 相比注册中心数据，更信任本地数据
  - 使用 Envoy 2X2 矩阵来决定节点是否应该路由

    | 发现状态 | 健康检查成功 | 健康检查失败 |
    | -------- | ------------ | ------------ |
    | 发现     | 路由         | 不路由       |
    | 未发现   | 路由         | 不路由，删除 |

- Q5：服务发布后，造成 N\*M 次事件通知，形成广播风暴，该如何解决？
  - 将消息推送合并

## Service Mesh 中的注册中心

- 涉及跨集群访问
  - EDS 服务发现规范
- 与 K8S 集群结合
  - 需要注意节点 IP 变化的问题

## Service Mesh 中的注册中心的优势

- 由 sidercar 代理注册，减少服务开发量，可以控制注册 meta 信息一致化
- 通过控制面聚合多种、多个注册中心数据，降低单一注册中心的读写压力，更容易水平扩展
- 通过 sidercar 提供服务正确性检查功能，通过 header 中增加服务名与本地服务名称做校验
