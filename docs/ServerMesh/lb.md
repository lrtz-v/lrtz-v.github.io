---
template: main.html
tags:
  - Service Mesh
  - 负载均衡
---

# 负载均衡

## 应该选择什么样的负载均衡器

- 硬件负载均衡器

  - F5
  - Citrix NetScaler
  - radware
  - Array

- DNS 负载均衡
- 软件负载均衡

  - Nginx（七层）
  - HAProxy（七层）
  - LVS（四层）

- 程序内负载均衡：讲负载均衡放在服务程序内部
- Service Mesh 负载均衡：利用 sidercar 做负载均衡，属于软件负载均衡的一种

## 负载算法

- Round Robin：轮训算法，适合节点权重一致的场景
- Weighted Round Robin：将权重大的节点分散开，取最大公约数，做简单轮训；在服务重启时会出现请求集中的现象
- Weighted Random：通过随机的方式进行负载，配合二分查找，将时间复杂度降低到 logn，对后端节点非常均衡
- Two Random Choices：通过两次随机算法，选取两个节点，再对比两个节点的负载、延时等信息，选取最优的一个
- Stick Session：同一个客户端，负载到的节点相同，负载不均衡，慎用

## 服务发现后如何实现节点保护

- 主动健康检查
  - 在负载均衡中主动健康检查。
  - 会产生大量无用 ping；建议选择获取过少节点时才触发，如当前节点数比十五分钟前的少 20%时触发
- 恐慌阈值
  - 当健康检查后，可用的节点依然小于阈值（10%），则忽略健康检查的结果，把流量负载到所有节点，包括异常的节点，保证理由的均衡，健康的节点也不会因为激增的流量而雪崩
- 被动健康检查
  - 通过正常的流量判断节点是否正常，也就是利用节点熔断器
  - 将 499 及以上的错误码认为是后端服务异常，统计 10 秒滑动窗口内异常请求占比

## 节点染色

- 利用节点上的标签进行流量路由；把某一类节点打上相同标签，负载均衡器根据相同标签分发流量
  - 金丝雀发布、A/B 测试、故障演练、流量分区等
- 如何操作
  - 在网关层，根据 header 信息或者权重对流量进行染色
  - 在注册中心中也要写入对应的 metaData 信息，用户在负载均衡层进行流量过滤

## 地域优先访问

- 在 Envoy 中被称为 zone 感知路由
- 名词解释
  - 始发集群：调用方，Client 的服务节点集群
  - 上游集群：被调用方，Server 服务节点集群
  - zone：区域（Region）和可用区（Availability Zone）
- zone 感知路由，会根据始发集群的所在区节点数量和目标集群的所在区节点数量，动态计算一个相对的比例；通过动态计算上下游的节点数，将流量正确的路由到各个分区，避免上游集群承受过大的访问量而崩溃
